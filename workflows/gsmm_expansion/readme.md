# Running the GSMM_Expansion workflow

![overview](case_study1.png)

## Required installation

To run this workflow you need to install CarveMe, which requires that you install CPLEX manually.
Please follow the instructions [here](https://carveme.readthedocs.io/en/latest/installation.html)

**Please name your CarveMe environment as `carveme_env`**

To download and install CPLEX:

1. go to https://www.ibm.com/academic/topic/data-science
2. Download it (e.g.,`ILOG_COS_20.10_LINUX_X86_64`)
3. Execute `chmod a+x file` on the download file.
4. Execute `./file`.
5. Execute `sudo chmod -R 777 /opt/ibm`
6. Execute `python /opt/ibm/ILOG/CPLEX_Studio201/cplex/python/3.8/x86-64_linux/setup.py install`

The exact paths above will depend on your system, I only provided an example.

You also need to install [Mantis](https://github.com/PedroMTQ/mantis) on your unifuncnet conda environment.

```
    conda install python=3.9
    conda install -c anaconda networkx
    conda install mantis_pfa -c bioconda
```

This workflow uses the KOfam and Metacyc reference databases for functional annotation.
To generate the Metacyc reference database go [here](https://github.com/PedroMTQ/refdb_generator) and clone the repo.
You also need the files `proteins.dat` and `protseq.fsa` which you can download after obtaining the MetaCyc academic
license:

1. Request [Metacyc license](https://metacyc.org/download.shtml)
2. Download the `Metacyc flat files`
3. Export the `protseq.fsa` and `proteins.dat` in data to an `metacyc_ref_path`
4. Run `python Reference_Generator.py -db metacyc -o metacyc_ref_path`

If the Metacyc reference database is not available, only KOfam is used. I strongly suggest using both.

## Executing workflow

To execute this workflow simply
do `unifuncnet gsmm_expansion -i input_folder -o output_folder -db list_dbs -mr path_to_metacyc_ref -pt politeness_timer`

- The `input_folder` variable should be a folder with one or more protein sequences fastas.
- The `output_folder` will be the directory where this workflow outputs its analysis. This folder contains the following
  folders and files:
    - `models` - CarveMe models, built by running CarveMe on the fastas
    - `mantis_input.tsv` - tsv with fastas path to be used in Mantis
    - `mantis_output` - Mantis annotations, generated by functionally annotated the fastas
    - `unifuncnet_input` - UniFuncNet's input tsv, containing the annotations from Mantis minus the annotations already
      in the CarveMe models
    - `unifuncnet_output` - UniFuncNet's output, i.e., data gathered on compounds,reactions, and proteins, as well as
      the corresponding graph in `.sif` format
    - `workflow_output` - the expanded networks in `.sif` format, each network has 4 columns, `SOURCE`,`INTERACTION`
      ,`TARGET`, and`EXPANSION`. The `SOURCE` and `TARGET` nodes can either be the IDs from the original network or
      the `internal_id`s from UniFuncNet. The `INTERACTION` column describes the type of connection (either `cr` for
      a `compound->reaction` edge or `rc` for `reaction->compound` edge). The `EXPANSION` column marks (1/0) whether the
      current edge came from the original CarveMe model (`0`), or if it was added during the expansion (`1`). **The
      network expansion only add edges if they are somehow connected to the original network**.
    - `console.out` - console output
- The `database` can be used to choose which database you want to collect data from. By default, all the databases (
  kegg,rhea,metacyc,hmdb) are used.
- You can additionally add `-oc` or `--only_connected` when running this workflow. With `-oc` the resulting `.sif`
  networks will only contain the additional edges that connect to compounds in the original network.
- the `path_to_metacyc_ref` is the path to the Metacyc reference database to be used by Mantis. You can create it
  following the instructions [here](https://github.com/PedroMTQ/refdb_generator). Keep in mind this requires that the
  metacyc data is available (see UniFuncNet's readme)